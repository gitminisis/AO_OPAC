<!DOCTYPE html>
<!-- PubSecureLogin.html -->
<!-- 
	This page is called to log on to public secure. Go to this page with no URL parameters
	and the code will check if the user is already authenticated. If the user is not authenticated 
	the user will be redirected to the Public Secure logon page and then be redirected back to
	this page with the authentication tokens in the URL parameters.
-->
<html>

<head>
	<script src="https://global.oktacdn.com/okta-auth-js/5.3.1/okta-auth-js.polyfill.js"
		type="text/javascript"></script>
	<script src="https://global.oktacdn.com/okta-auth-js/5.3.1/okta-auth-js.min.js" type="text/javascript"></script>
	<script src="../js/configps.js" type="text/javascript"></script>
</head>

<body>
	<script>
		const authClient = new OktaAuth(conectoptions);


		async function main() {
			//alert("Start of login page");
			//debugger;
			var userinfo = null;
			var useremail = null;
			var usersubscription = null;

			if (authClient.isLoginRedirect()) { // check if this is a redirect
				try {
					//alert("In the login redirect");
					// debugger;
					// parse tokens from the redirect and store.
					await authClient.storeTokensFromRedirect();
					// get the user info.
					userinfo = await authClient.getUser();
					if (userinfo) {
						// debugger;
						useremail = userinfo.email;
						usersubscription = userinfo.sub;

						console.log(useremail);
						console.log(usersubscription);
						window.location = "https://aoopac.minisisinc.com";
						/*
							if (useremail is a MINISIS user) {
								log in to MINISIS using this email.
								redirect back to main page with the user logged in.
							}
							else {
								if (usersubscription exists in the user database) {
									The user has changed their email address in public secure.
									Update user name (email) in user profile.
									log in to MINISIS using this new email.
									redirect back to main page with the user logged in.
								}
								else {
									new user - handle as new user create the new user in MINISIS
									redirect user to filling out the rest of the MINISIS user profile.
								}
							}
						*/
						
					}
					else {
						// for some reason the user information can not be retrieved error message or redirect to home page.
						// console.log('Could not get the user info');
						// debugger;

						window.location = "https://aoopac.minisisinc.com";
					}
				}
				catch (e) {
					// the most likely cause of an exception will be an URL with bad parameters that the 
					// Okta library could not handle. Should most likely redirect to the home page or display an error.
					// console.log(e);
					// debugger;

					window.location = "https://aoopac.minisisinc.com";
				}
			}
			else if (!await authClient.isAuthenticated()) {
				// Not logged in. Redirect to the public secure logon page.
				// After the user signs into public secure they will be redirected to this page
				// with tokens in the URL
				//alert("In the sign in with redirect");
				authClient.signInWithRedirect();

			}
			else {
				// user is already logged in - Could add some checks that the user is logged in on the MINISIS 
				// side and then redirect back to the home page.

				window.location = "https://aoopac.minisisinc.com";
			}
		}

		main();
	</script>

</body>